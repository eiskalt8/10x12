<!DOCTYPE html>
<html lang="de" xmlns="http://www.w3.org/1999/html">
<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>10x12</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="js/skript.js"></script>
    <script crossorigin="anonymous"
            integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg=="
            referrerpolicy="no-referrer"
            src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script crossorigin="anonymous"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            referrerpolicy="no-referrer"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        let room_number = window.location.pathname
        room_number = room_number.split('/')
        room_number = room_number[2]
        const uuid = localStorage.getItem('uuid')
        const uuid_part = uuid.substring(0, 8)
        const username = localStorage.getItem('username')
        let room_locked = false
        let is_current_player = false
    </script>
    <style>
        .dice {
            font-size: xxx-large;
            transition: transform 0.5s ease-in-out;
            margin-right: 0.2em;
            margin-left: 0.2em;
        }

        .rolling {
            animation: rollAnimation 0.5s ease-in-out;
        }

        .locked {
            filter: contrast(20%);
        }

        @keyframes rollAnimation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .dicebox {
            box-sizing: content-box;
            border-color: var(--bs-primary);
            margin-right: 1.5em;
            margin-left: 1.5em;
            margin-bottom: 0.8em;
        }

        /* TODO */
        .custom_border {
            border: 3px solid #198754;
        !important
        }
    </style>
</head>
<body onload="get_name()">
<script charset="utf-8" type="text/javascript">
    socket.on('connect', function () {
        console.log("connected")
        // triggering join_room after refresh or if joined manually
        socket.emit('join_room', {
            room_number: room_number,
            uuid: uuid
        });
        // for only get current dices at reload
        socket.emit('dices', {
            room_number: room_number,
            uuid: uuid,
            dices: false,
            locked_dices: false
        });
    });

    socket.on('disconnect', function () {
        console.log("disconnected")
    });

    socket.on('room_locked', function (data) {
        if ('message' in data) {
            const locktext = document.getElementById('lockmsg-text');
            locktext.textContent = data['message'];
            const lockmsg = document.getElementById('lockmsg');
            lockmsg.style.display = 'block';
        }
        room_locked = true
    });

    function rollDice() {
        // need to lock the room?
        if (room_locked === false) {
            socket.emit('lock_room', {
                room_number: room_number
            });
        }
        const diceIds = ["dice1", "dice2", "dice3", "dice4", "dice5", "dice6"];
        let dices = {};
        let locked_dices = [];
        let completed = 0
        document.getElementById('würfel').disabled = true;
        setTimeout(function () {
            document.getElementById('würfel').disabled = false;
        }, 2000);

        diceIds.forEach(diceId => {
            const diceElement = document.getElementById(diceId);
            if (!diceElement.classList.contains('locked')) {
                diceElement.classList.add('rolling');
                setTimeout(() => {
                    if (diceElement.classList.contains('rolling')) {
                        const randomNumber = Math.floor(Math.random() * 6) + 1;
                        diceElement.classList.remove('rolling');
                        diceElement.className = `bi bi-dice-${randomNumber} dice`;
                        dices[diceId.charAt(4)] = randomNumber;

                        completed++

                    }
                }, 500);// Wait in Millisec
            } else {
                locked_dices.push(diceId);
                completed++
            }
            if (completed === diceIds.length) {
                socket.emit('dices', {
                    room_number: room_number,
                    uuid: uuid,
                    dices: dices,
                    locked_dices: locked_dices
                });
            }
        });
    }

    function next() {
        document.getElementById('next').disabled = true;
        document.getElementById('würfel').disabled = true;
        for (let i = 1; i <= 6; i++) {
            document.getElementById(`lock${i}`).disabled = true;
        }
        if (is_current_player === true) {
            socket.emit('next_player', {
                room_number: room_number,
                uuid: uuid
            });
        }
    }
</script>

<nav class="navbar">
    <div class="container-fluid">
        <div class="row align-items-center w-100" style="flex-grow: 1">
            <div class="col w-100">
                <a class="navbar-brand" href="">
                    <img alt="Logo" class="d-inline-block align-text-top" height="80" src="Logo_name.png" width="80">
                </a>
            </div>
            <div class="col w-100 text-center">
                <span class="navbar-text" style="font-size:xx-large">
                    10x12
                </span>
            </div>
            <div class="col w-100 text-end">
                <button class="btn btn-info" type="button">
                    <i class="bi bi-lightbulb"></i>
                    <i class="bi bi-lightbulb-fill"></i>
                </button>
            </div>
        </div>
    </div>
</nav>


<div class="container-fluid text-center">
    <div class="row">
        <!-- left side -->
        <div class="col-sm">
            <table class="table table-sm table-striped table-bordered border-primary caption-top" id="Table1">
                <caption class="text-center" id="player1"></caption>
                <tbody class="border-primary">
                </tbody>
            </table>
            <table class="table table-sm table-striped table-bordered border-primary caption-top" id="Table3">
                <caption class="text-center" id="player3"></caption>
                <tbody class="border-primary">
                </tbody>
            </table>
            <table class="table table-sm table-striped table-bordered border-primary caption-top" id="Table5">
                <caption class="text-center" id="player5"></caption>
                <tbody class="border-primary">
                </tbody>
            </table>
        </div>
        <!-- center -->
        <div class="col-lg-6">
            <div class="rounded" id="border_player_table">
                <table class="table table-striped table-hover table-bordered border-primary caption-top"
                       id="playerTable" style="margin-bottom: 0">
                    <caption class="text-center"><strong id="username"></strong></caption>
                    <thead>
                    </thead>
                    <tbody class="table-group-divider border-primary">
                    </tbody>
                </table>
            </div>
            <div class="container text-center">
                <div class="d-flex justify-content-center align-items-center">
                    <i class="bi bi-dice-1 dice" id="dice1"></i>
                    <i class="bi bi-dice-2 dice" id="dice2"></i>
                    <i class="bi bi-dice-3 dice" id="dice3"></i>
                    <i class="bi bi-dice-4 dice" id="dice4"></i>
                    <i class="bi bi-dice-5 dice" id="dice5"></i>
                    <i class="bi bi-dice-6 dice" id="dice6"></i>
                </div>
                <div class="d-flex justify-content-center align-items-center" style="margin-bottom: 0.5em">
                    <div>
                        <input class="form-check-input dicebox" disabled id="lock1"
                               onchange="toggleLock('dice1')" type="checkbox">
                    </div>
                    <div>
                        <input class="form-check-input dicebox" disabled id="lock2"
                               onchange="toggleLock('dice2')" type="checkbox">
                    </div>
                    <div>
                        <input class="form-check-input dicebox" disabled id="lock3"
                               onchange="toggleLock('dice3')" type="checkbox">
                    </div>
                    <div>
                        <input class="form-check-input dicebox" disabled id="lock4"
                               onchange="toggleLock('dice4')" type="checkbox">
                    </div>
                    <div>
                        <input class="form-check-input dicebox" disabled id="lock5"
                               onchange="toggleLock('dice5')" type="checkbox">
                    </div>
                    <div>
                        <input class="form-check-input dicebox" disabled id="lock6"
                               onchange="toggleLock('dice6')" type="checkbox">
                    </div>
                </div>
                <div class="d-flex justify-content-center align-items-center" style="margin-bottom: 0.5em">
                    <button class="btn btn-primary" disabled id="würfel"
                            onclick="rollDice()" style="margin-right: 0.8em; margin-left: 0.8em">
                        Würfeln
                    </button>
                    <button class="btn btn-primary" disabled id="next"
                            onclick="next()" style="margin-right: 0.8em; margin-left: 0.8em">
                        Weiter
                    </button>
                </div>
            </div>
            <!-- ONLY FOR DEV -->
            <div class="container text-center">
                Spieler am Zug: <p id="current_player"></p>
            </div>
            <!-- ONLY FOR DEV -->
            <div class="container text-center">
                <div class="container text-center alert alert-danger alert-dismissible" id="lockmsg" role="alert"
                     style="display: none; max-width: fit-content">
                    <div id="lockmsg-text"></div>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                </div>
                <div class="d-flex justify-content-center">
                    <div class="alert alert-info alert-dismissible fade show" role="alert"
                         style="max-width: fit-content;">
                        <strong>Achtung!</strong> Nach dem ersten Würfeln ist der Raum gesperrt, und keine weiteren
                        Spieler können beitreten.
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                    </div>
                </div>
            </div>
        </div>
        <!-- right side -->
        <div class="col-sm">
            <table class="table table-sm table-striped table-bordered border-primary caption-top" id="Table2">
                <caption class="text-center" id="player2"></caption>
                <tbody class="border-primary">
                </tbody>
            </table>
            <table class="table table-sm table-striped table-bordered border-primary caption-top" id="Table4">
                <caption class="text-center" id="player4"></caption>
                <tbody class="border-primary">
                </tbody>
            </table>
            <table class="table table-sm table-striped table-bordered border-primary caption-top" id="Table6">
                <caption class="text-center" id="player6"></caption>
                <tbody class="border-primary">
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    // generate big table
    const tableHead = document.querySelector('#playerTable thead');

    let headHtml = '<th scope="col">Zahlen</th>';
    for (let col = 1; col <= 10; col++) {
        headHtml += '<th scope="col">' + col + '</th>';
    }
    headHtml += '<th scope="col">Zahlen</th>';

    tableHead.innerHTML = headHtml;

    const tableBody = document.querySelector('#playerTable tbody');

    for (let row = 1; row <= 12; row++) {
        let rowHtml = '<tr><th scope="row">' + row + '</th>';

        for (let col = 1; col <= 10; col++) {
            rowHtml += '<td><input class="form-check-input" type="checkbox" id="' + row + '-' + col + '" style="border-color: var(--bs-primary)"></td>';
        }

        rowHtml += '<th scope="row">' + row + '</th></tr>';
        tableBody.innerHTML += rowHtml;
    }

    // generate other user tables
    socket.on('update_amount_tables', function (data) {
        let nameList = data.names;
        generatePlayerTables(nameList);
        let player = data.current_player;
        const current_player_p = document.getElementById("current_player");
        if (!(player === "nicht gefunden!")) { // if uuid was found
            current_player_p.innerHTML = player // TODO change border color from current_player_table
            if (player === uuid_part) {
                is_current_player = true // set variable to allow next()
                activate_buttons()
            }
        } else {
            current_player_p.innerHTML = "Aktueller Spieler konnte nicht ermittelt werden"
        }
    });

    function generatePlayerTables(nameList) {
        const ownuuid_part = uuid.substring(0, 8);
        let names = nameList.filter(user => user[1] !== ownuuid_part); // removing own username
        let numPlayers = names.length;

        for (let i = 1; i <= numPlayers; i++) {
            const tableBody = document.querySelector(`#Table${i} tbody`);

            if (tableBody.children.length === 0) {
                const tableCaption = document.querySelector(`#Table${i} caption`);
                tableCaption.innerHTML = names[i - 1][0]; // array starts at 1, i at 1 / [[name, uuidpart],[name, uuidpart]]

                for (let row = 1; row <= 12; row++) {
                    let rowHtml = `<tr><th scope="row">${row}</th>`;

                    for (let col = 1; col <= 10; col++) {
                        rowHtml += `<td id="${row}-${col}"></td>`;
                    }

                    rowHtml += `<th scope="row">${row}</th></tr>`;
                    tableBody.innerHTML += rowHtml;
                }
            }
        }
    }

    socket.on('new_next_player', function (data) {
        let currentPlayer = data.current_player;
        if (currentPlayer === uuid_part) {
            is_current_player = true
            activate_buttons()
        }
        const current_player_p = document.getElementById("current_player");
        current_player_p.innerHTML = currentPlayer
        // TODO change border color from current_player_table
    });

    function activate_buttons() {
        if (is_current_player === true) {
            document.getElementById('würfel').disabled = false;
            document.getElementById('next').disabled = false;
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`lock${i}`).disabled = false;
            }
        }
    }

    socket.on('new_dices', function (data) {
        const new_dices = data.new_dices;
        const locked_dices = data.locked_dices;
        const diceIds = ["dice1", "dice2", "dice3", "dice4", "dice5", "dice6"];

        diceIds.forEach(diceId => {
            const diceElement = document.getElementById(diceId);
            diceElement.classList.remove('locked')
            if (diceId in locked_dices) {
                diceElement.classList.add('locked')
            }
            if (!diceElement.classList.contains('locked')) {
                diceElement.classList.add('rolling');
                setTimeout(() => {
                    diceElement.classList.remove('rolling');
                    diceElement.className = `bi bi-dice-${new_dices[diceId.charAt(4)]} dice`;
                }, 500);// Wait in Millisec
            }
        });
    });
</script>
</body>
</html>